{% extends "base.html" %}

{% block title %}{{ metadata.name|e or model_name }} - Civitai Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="fas fa-brain me-2"></i>
            {{ metadata.name|e or model_name }}
        </h1>
        <h2 class="h5 text-muted">
            Version {{ version.name|e or 'N/A' }} by {{ metadata.creator.username|e if metadata.creator and metadata.creator.username else 'Unknown' }}
        </h2>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="fas fa-trash-alt me-1"></i>
            Delete
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Back
        </a>
    </div>
</div>

<div class="row align-items-start">
    <!-- Left Column: Previews -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images me-2"></i>Preview Images</h5>
            </div>
            <div class="card-body" style="overflow-y: auto; flex-grow: 1;">
                {% if version.images %}
                <div class="row row-cols-1 row-cols-lg-2 g-3 p-3"> {# 1 col on small, 2 on large screens, p-3 for padding #}
                    {% for image in version.images %}
                    <div class="col">
                        <div class="card bg-light shadow-sm h-100">
                            {% if image.local_url.endswith(('.mp4', '.webm', '.ogg')) %}
                                <video class="img-fluid" controls style="border-radius: var(--bs-card-inner-border-radius);">
                                    <source src="{{ image.local_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% else %}
                                <a href="{{ image.local_url }}" target="_blank" title="Click to open full image">
                                    <img src="{{ image.local_url or url_for('static', filename='placeholder.png') }}" class="img-fluid" alt="Preview image {{ loop.index }}" style="border-radius: var(--bs-card-inner-border-radius);">
                                </a>
                            {% endif %}
                            
                            {% if image.nsfw %}
                            <div class="card-img-overlay d-flex justify-content-end align-items-start p-2">
                                <span class="badge bg-danger">NSFW</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No preview images available</h5>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Info -->
    <div class="col-lg-4">
        <!-- Model Info -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Model Information</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Type:</strong> <span class="badge bg-secondary">{{ metadata.type or 'Unknown' }}</span></p>
                <p class="mb-1"><strong>Model ID:</strong> {{ metadata.id or 'N/A' }}</p>
                <p class="mb-1"><strong>Version ID:</strong> {{ version.id or 'N/A' }}</p>
                <hr>
                <p class="mb-1"><strong>Base Model:</strong> <span class="badge bg-info">{{ version.baseModel or 'Unknown' }}</span></p>
                <p class="mb-1"><strong>Created:</strong> <small>{{ version.createdAt.split('T')[0] if version.createdAt else 'N/A' }}</small></p>
                <p class="mb-0"><strong>Updated:</strong> <small>{{ version.updatedAt.split('T')[0] if version.updatedAt else 'N/A' }}</small></p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h5>
            </div>
            <div class="card-body">
                {% if version.stats %}
                    <div class="row">
                        <div class="col-6 mb-2"><i class="fas fa-download me-2 text-primary"></i>{{ version.stats.get('downloadCount', 0) | int }}</div>
                        <div class="col-6 mb-2"><i class="fas fa-heart me-2 text-danger"></i>{{ version.stats.get('favoriteCount', 0) | int }}</div>
                        <div class="col-6 mb-2"><i class="fas fa-star me-2 text-warning"></i>{{ "%.2f"|format(version.stats.get('rating', 0)) }} ({{ version.stats.get('ratingCount', 0) | int }})</div>
                        <div class="col-6 mb-2"><i class="fas fa-comments me-2 text-info"></i>{{ version.stats.get('commentCount', 0) | int }}</div>
                    </div>
                {% else %}
                    <p class="text-muted">No statistics available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Tags -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-tags me-2"></i>Tags</h5></div>
            <div class="card-body">
                {% if metadata.tags %}
                    {% for tag in metadata.tags %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ tag|e }}</span>
                    {% endfor %}
                {% elif version.trainedWords %} {# Fallback to trainedWords if metadata.tags is empty #}
                    {% for word in version.trainedWords %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ word|e }}</span>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No tags available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Trained Words -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Trained Words</h5></div>
            <div class="card-body">
                {% for word in version.trainedWords %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ word|e }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Description and File Info Row -->
<div class="row mt-4 mb-5">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Description</h5>
            </div>
            <div class="card-body">
                <div id="description-container" class="description-collapsed">
                    {{ metadata.description | safe if metadata.description else 'No description provided.' }}
                </div>
                <button id="read-more-btn" class="btn btn-link btn-sm p-0 mt-1">Read more</button>
            </div>
            <div class="card-footer">
                {% if version.files and version.files[0] %}
                    {% set file = version.files[0] %}
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>File: </strong><span class="text-break">{{ file.name|e or 'N/A' }}</span></p>
                            <p class="mb-0"><strong>Size: </strong>{{ "%.2f"|format(file.sizeKB / 1024) }} MB</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            {% if model_files and model_files[0] %}
                                {% set local_file_path = model_files[0] %}
                                <a href="{{ url_for('local_model_files', filename=local_file_path) }}" target="_blank" class="btn btn-success btn-sm">
                                    <i class="fas fa-download me-1"></i> Download
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <hr class="my-2">
                    <p class="mb-0"><strong>Hash (SHA256):</strong> 
                        <small class="text-muted text-break user-select-all">{{ file.hashes['SHA256'] or 'N/A' }}</small>
                    </p>
                {% else %}
                    <p class="text-muted">No file information available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    #description-container.description-collapsed {
        max-height: 200px; /* Adjust height as needed */
        overflow: hidden;
        position: relative;
        -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    }
    #read-more-btn.hidden {
        display: none;
    }
    .col-lg-8 .card {
        display: flex;
        flex-direction: column;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Model</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the model '{{ metadata.name|e or model_name|e }}'?</p>
        <p>This will remove all associated metadata and preview images.</p>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="" id="deleteModelFileCheckbox">
          <label class="form-check-label" for="deleteModelFileCheckbox">
            Also delete the model file(s) from the models directory.
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" action="{{ url_for('delete_model', model_name=model_name) }}" method="POST" style="display: inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="delete_model_file" id="deleteModelFileHiddenInput" value="false">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteCheckbox = document.getElementById('deleteModelFileCheckbox');
    const deleteHiddenInput = document.getElementById('deleteModelFileHiddenInput');
    const deleteForm = document.getElementById('deleteForm');

    if (deleteCheckbox && deleteHiddenInput && deleteForm) {
        deleteForm.addEventListener('submit', function() {
            deleteHiddenInput.value = deleteCheckbox.checked;
        });
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('description-container');
    const btn = document.getElementById('read-more-btn');

    if (container && btn) {
        if (container.scrollHeight <= container.clientHeight) {
            btn.classList.add('hidden');
        }

        btn.addEventListener('click', function() {
            if (container.classList.contains('description-collapsed')) {
                container.classList.remove('description-collapsed');
                container.style.webkitMaskImage = 'none';
                container.style.maskImage = 'none';
                btn.textContent = 'Read less';
            } else {
                container.classList.add('description-collapsed');
                container.style.webkitMaskImage = 'linear-gradient(to bottom, black 50%, transparent 100%)';
                container.style.maskImage = 'linear-gradient(to bottom, black 50%, transparent 100%)';
                btn.textContent = 'Read more';
            }
        });
    }
});

window.addEventListener('load', function() {
    const rightColumn = document.querySelector('.col-lg-4');
    const leftCard = document.querySelector('.col-lg-8 .card');

    function adjustHeight() {
        if (rightColumn && leftCard) {
            leftCard.style.height = `${rightColumn.offsetHeight}px`;
        }
    }

    adjustHeight();
    window.addEventListener('resize', adjustHeight);
});
</script>
{% endblock %}