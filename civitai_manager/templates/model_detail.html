{% extends "base.html" %}

{% block title %}{{ metadata.name|e or model_name }} - Civitai Archive{% endblock %}

{% block extra_head %}
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
{% endblock %}

{% block content %}
<style>
    /* Make the preview card body fill available height */
    .col-lg-8 .card { display: flex; flex-direction: column; }
        .col-lg-8 .card .card-body { flex: 1; display: flex; overflow: hidden; }

    /* Swiper container fills body */
    #previewCarousel.swiper { width: 100%; height: 100%; }
    #previewCarousel .swiper-wrapper { height: 100%; align-items: center; }
    #previewCarousel .swiper-slide { height: 100%; display: flex; align-items: center; justify-content: center; }
    #previewCarousel .swiper-slide .position-relative { width: 100%; height: 100%; }

    /* Media scales to touch either width or height with no extra margins */
    #previewCarousel .swiper-slide img,
    #previewCarousel .swiper-slide video {
        width: 100%;
        height: 100%;
        object-fit: contain; /* portrait: touches top/bottom; landscape: touches left/right */
        object-position: center center;
        display: block;
    }

    /* Keep NSFW badge visible */
    #previewCarousel .badge { pointer-events: none; }

    /* Optional: adjust pagination placement slightly inside */
    #previewCarousel .swiper-pagination { bottom: 8px; }

    @media (max-width: 991px) {
        /* On small screens let the preview take a reasonable height */
        #previewCarousel.swiper { min-height: 260px; }
    }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="fas fa-brain me-2"></i>
            {{ metadata.name|e or model_name }}
        </h1>
        <h2 class="h5 text-muted">
            Version {{ version.name|e or 'N/A' }} by {{ metadata.creator.username|e if metadata.creator and metadata.creator.username else 'Unknown' }}
        </h2>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="fas fa-trash-alt me-1"></i>
            Delete
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Back
        </a>
    </div>
</div>

<div class="row align-items-start">
    <!-- Left Column: Previews -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images me-2"></i>Preview Images</h5>
            </div>
            <div class="card-body p-0">
                                                                {% if version.images %}
                                                                                                <div class="swiper" id="previewCarousel">
                                                                    <div class="swiper-wrapper">
                                                                        {% for image in version.images %}
                                                                        <div class="swiper-slide">
                                                                                                            <div class="position-relative w-100 h-100">
                                                                                                                {% if image.local_url.endswith((".mp4", ".webm", ".ogg")) %}
                                                                                                                    <video class="preview-media" controls>
                                                                                        <source src="{{ image.local_url }}" type="video/mp4">
                                                                                        Your browser does not support the video tag.
                                                                                    </video>
                                                                                                                        {% else %}
                                                                                                                            <img src="{{ image.local_url or url_for('static', filename='placeholder.png') }}" alt="Preview image {{ loop.index }}" class="preview-media">
                                                                                                                        {% endif %}
                                                                                {% if image.nsfw %}
                                                                                <div class="position-absolute top-0 end-0 p-2">
                                                                                    <span class="badge bg-danger">NSFW</span>
                                                                                </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                    <!-- Pagination bullets -->
                                                                    <div class="swiper-pagination"></div>
                                                                    <!-- Navigation buttons -->
                                                                    <div class="swiper-button-prev"></div>
                                                                    <div class="swiper-button-next"></div>
                                                                </div>
                                {% else %}
                                    <div class="text-center py-5">
                                            <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No preview images available</h5>
                                    </div>
                                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Info -->
    <div class="col-lg-4">
        <!-- Model Info -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Model Information</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Type:</strong> <span class="badge bg-secondary">{{ metadata.type or 'Unknown' }}</span></p>
                <p class="mb-1"><strong>Model ID:</strong> {{ metadata.id or 'N/A' }}</p>
                <p class="mb-1"><strong>Version ID:</strong> {{ version.id or 'N/A' }}</p>
                <hr>
                <p class="mb-1"><strong>Base Model:</strong> <span class="badge bg-info">{{ version.baseModel or 'Unknown' }}</span></p>
                <p class="mb-1"><strong>Created:</strong> <small>{{ version.createdAt.split('T')[0] if version.createdAt else 'N/A' }}</small></p>
                <p class="mb-0"><strong>Updated:</strong> <small>{{ version.updatedAt.split('T')[0] if version.updatedAt else 'N/A' }}</small></p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h5>
            </div>
            <div class="card-body">
                {% if version.stats %}
                    <div class="row">
                        <div class="col-6 mb-2"><i class="fas fa-download me-2 text-primary"></i>{{ version.stats.get('downloadCount', 0) | int }}</div>
                        <div class="col-6 mb-2"><i class="fas fa-heart me-2 text-danger"></i>{{ version.stats.get('favoriteCount', 0) | int }}</div>
                        <div class="col-6 mb-2"><i class="fas fa-star me-2 text-warning"></i>{{ "%.2f"|format(version.stats.get('rating', 0)) }} ({{ version.stats.get('ratingCount', 0) | int }})</div>
                        <div class="col-6 mb-2"><i class="fas fa-comments me-2 text-info"></i>{{ version.stats.get('commentCount', 0) | int }}</div>
                    </div>
                {% else %}
                    <p class="text-muted">No statistics available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Tags -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-tags me-2"></i>Tags</h5></div>
            <div class="card-body">
                {% if metadata.tags %}
                    {% for tag in metadata.tags %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ tag|e }}</span>
                    {% endfor %}
                {% elif version.trainedWords %} {# Fallback to trainedWords if metadata.tags is empty #}
                    {% for word in version.trainedWords %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ word|e }}</span>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No tags available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Trained Words -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header"><h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Trained Words</h5></div>
            <div class="card-body">
                {% for word in version.trainedWords %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ word|e }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Description and File Info Row -->
<div class="row mt-4 mb-5">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Description</h5>
            </div>
            <div class="card-body">
                <div id="description-container" class="description-collapsed">
                    {{ metadata.description | safe if metadata.description else 'No description provided.' }}
                </div>
                <button id="read-more-btn" class="btn btn-link btn-sm p-0 mt-1">Read more</button>
            </div>
            <div class="card-footer">
                {% if version.files and version.files[0] %}
                    {% set file = version.files[0] %}
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>File: </strong><span class="text-break">{{ file.name|e or 'N/A' }}</span></p>
                            <p class="mb-0"><strong>Size: </strong>{{ "%.2f"|format(file.sizeKB / 1024) }} MB</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            {% if model_files and model_files[0] %}
                                {% set local_file_path = model_files[0] %}
                                <a href="{{ url_for('local_model_files', filename=local_file_path) }}" target="_blank" class="btn btn-success btn-sm">
                                    <i class="fas fa-download me-1"></i> Download
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <hr class="my-2">
                    <p class="mb-0"><strong>Hash (SHA256):</strong> 
                        <small class="text-muted text-break user-select-all">{{ file.hashes['SHA256'] or 'N/A' }}</small>
                    </p>
                {% else %}
                    <p class="text-muted">No file information available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    #description-container.description-collapsed {
        max-height: 200px; /* Adjust height as needed */
        overflow: hidden;
        position: relative;
        -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    }
    #read-more-btn.hidden {
        display: none;
    }
    .col-lg-8 .card {
        display: flex;
        flex-direction: column;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const el = document.querySelector('#previewCarousel.swiper');
        if (el) {
            new Swiper(el, {
                loop: false,
                slidesPerView: 1,
                spaceBetween: 10,
                centeredSlides: true,
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                keyboard: {
                    enabled: true,
                },
            });
        }
    });
</script>
<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Model</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the model '{{ metadata.name|e or model_name|e }}'?</p>
        <p>This will remove all associated metadata and preview images.</p>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="" id="deleteModelFileCheckbox">
          <label class="form-check-label" for="deleteModelFileCheckbox">
            Also delete the model file(s) from the models directory.
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" action="{{ url_for('delete_model', model_name=model_name) }}" method="POST" style="display: inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="delete_model_file" id="deleteModelFileHiddenInput" value="false">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteCheckbox = document.getElementById('deleteModelFileCheckbox');
    const deleteHiddenInput = document.getElementById('deleteModelFileHiddenInput');
    const deleteForm = document.getElementById('deleteForm');

    if (deleteCheckbox && deleteHiddenInput && deleteForm) {
        deleteForm.addEventListener('submit', function() {
            deleteHiddenInput.value = deleteCheckbox.checked;
        });
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('description-container');
    const btn = document.getElementById('read-more-btn');

    if (container && btn) {
        if (container.scrollHeight <= container.clientHeight) {
            btn.classList.add('hidden');
        }

        btn.addEventListener('click', function() {
            if (container.classList.contains('description-collapsed')) {
                container.classList.remove('description-collapsed');
                container.style.webkitMaskImage = 'none';
                container.style.maskImage = 'none';
                btn.textContent = 'Read less';
            } else {
                container.classList.add('description-collapsed');
                container.style.webkitMaskImage = 'linear-gradient(to bottom, black 50%, transparent 100%)';
                container.style.maskImage = 'linear-gradient(to bottom, black 50%, transparent 100%)';
                btn.textContent = 'Read more';
            }
        });
    }
});

window.addEventListener('load', function() {
    const rightColumn = document.querySelector('.col-lg-4');
    const leftCard = document.querySelector('.col-lg-8 .card');

    function adjustHeight() {
        if (rightColumn && leftCard) {
            leftCard.style.height = `${rightColumn.offsetHeight}px`;
        }
    }

    adjustHeight();
    window.addEventListener('resize', adjustHeight);
});
</script>
{% endblock %}