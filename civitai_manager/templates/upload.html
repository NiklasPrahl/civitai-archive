{% extends "base.html" %}

{% block title %}Model Upload - Civitai Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-upload me-2"></i>
        Model Upload
    </h1>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>
        Back to Dashboard
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body p-5">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div id="uploadFormContent">
                        {{ form.hidden_tag() }}
                        <div class="mb-4">
                            <div class="upload-area p-5 text-center border rounded bg-light mb-3">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                <h5 class="text-muted mb-3">Drag and drop your model file here</h5>
                                <p class="text-muted small mb-3">or</p>
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('{{ form.model_file.id }}').click()">
                                        <i class="fas fa-folder-open me-2"></i>
                                        Browse Files
                                    </button>
                                    {{ form.model_file(class="d-none", accept=".safetensors,.ckpt,.pt,.pth,.bin") }}
                                </div>
                            </div>
                            <!-- File Info -->
                            <div id="fileInfo" class="card my-4 d-none shadow-sm">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-file-info me-2"></i>
                                        File Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Filename:</strong> <span id="fileName"></span></p>
                                            <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>File Type:</strong> <span id="fileType"></span></p>
                                            <p><strong>Last Modified:</strong> <span id="fileModified"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2" id="uploadButton" disabled>
                                <i class="fas fa-upload me-2"></i>
                                Upload Model
                            </button>
                            {% if form.model_file.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.model_file.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-link text-muted p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#uploadProcessCollapse" aria-expanded="false" aria-controls="uploadProcessCollapse">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Upload Process Details
                                    <i class="fas fa-chevron-down ms-1 small collapse-arrow"></i>
                                </small>
                            </button>
                            <div class="ms-auto">
                                <a href="#" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal">
                                    <i class="fas fa-question-circle me-2"></i>
                                    Help
                                </a>
                            </div>
                        </div>
                        <div class="collapse mt-2" id="uploadProcessCollapse">
                            <div class="card border-0 bg-light">
                                <div class="card-body p-4 upload-info">
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <div class="process-step">
                                                    <i class="fas fa-save text-primary opacity-75"></i>
                                                    <div class="ms-3">
                                                        <p class="mb-1 fw-medium">File is saved</p>
                                                        <small class="text-muted">In the configured models directory</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-start mt-4">
                                                <div class="process-step">
                                                    <i class="fas fa-cogs text-primary opacity-75"></i>
                                                    <div class="ms-3">
                                                        <p class="mb-1 fw-medium">Processing starts</p>
                                                        <small class="text-muted">Automatic processing after upload</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-start mt-4">
                                                <div class="process-step">
                                                    <i class="fas fa-database text-primary opacity-75"></i>
                                                    <div class="ms-3">
                                                        <p class="mb-1 fw-medium">Metadata retrieval</p>
                                                        <small class="text-muted">From Civitai via file hash</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <div class="process-step">
                                                    <i class="fas fa-images text-primary opacity-75"></i>
                                                    <div class="ms-3">
                                                        <p class="mb-1 fw-medium">Preview images</p>
                                                        <small class="text-muted">Downloaded per configuration</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-start mt-4">
                                                <div class="process-step">
                                                    <i class="fas fa-code text-primary opacity-75"></i>
                                                    <div class="ms-3">
                                                        <p class="mb-1 fw-medium">Overview update</p>
                                                        <small class="text-muted">HTML updates automatically</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Progress States Container -->
                <div id="uploadProgress" class="d-none">
                    <!-- Upload State -->
                    <div class="upload-state">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-shrink-0">
                                <i class="fas fa-cloud-upload-alt fa-2x text-primary me-3"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1" id="progressTitle">Uploading Model</h5>
                                <div id="progressText" class="text-muted small">Preparing upload...</div>
                            </div>
                        </div>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary position-relative" 
                                 role="progressbar" style="width: 0%" id="progressBar">
                                <span class="position-absolute w-100 text-center" style="left: 0; line-height: 20px;">0%</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="text-muted small" id="uploadStats"></div>
                            <div id="processingSpinner" class="d-none ms-2">
                                <div class="spinner-border text-success" role="status" style="width: 1.5rem; height: 1.5rem;">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                            </div>
                        </div>
                        <div id="uploadSuccessAlert" class="alert alert-success d-none mt-3 mb-0" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            Upload successful! Model is being processed ...
                        </div>
                    </div>
                </div>

            </div>
            </div>
        

        <!-- Help Modal -->
        <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="helpModalLabel">
                            <i class="fas fa-question-circle me-2"></i>
                            Help & Tips
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
    <script>
        // Enable upload button when a file is selected
        document.getElementById('{{ form.model_file.id }}').addEventListener('change', function() {
            document.getElementById('uploadButton').disabled = !this.files.length;
        });

        // Enable upload button when a file is dropped
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const fileInput = document.getElementById('{{ form.model_file.id }}');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                document.getElementById('uploadButton').disabled = false;
            }
        });
    </script>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Supported Formats:</h6>
                                <ul class="small">
                                    <li><strong>.safetensors</strong> - Safe tensor files</li>
                                    <li><strong>.ckpt</strong> - Checkpoint files</li>
                                    <li><strong>.pt/.pth</strong> - PyTorch models</li>
                                    <li><strong>.bin</strong> - Binary model files</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Important Notes:</h6>
                                <ul class="small">
                                    <li>Maximum file size: 500MB</li>
                                    <li>Files are processed automatically</li>
                                    <li>Metadata is retrieved from Civitai</li>
                                    <li>Preview images are downloaded</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> Make sure you have configured the directories before uploading models.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const fileInput = document.getElementById('{{ form.model_file.id }}');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    const fileModified = document.getElementById('fileModified');
    const form = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressTitle = document.getElementById('progressTitle');
    const progressText = document.getElementById('progressText');
    const uploadStats = document.getElementById('uploadStats');
    const uploadButton = document.getElementById('uploadButton');

    // Initially hide progress and success messages
    uploadProgress.classList.add('d-none');

    // Show file info when file is selected
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            let type = file.type || 'Unknown';
            const extension = file.name.split('.').pop().toLowerCase();
            if (type === 'Unknown' || type === 'application/octet-stream') {
                const known_extensions = ['safetensors', 'ckpt', 'pt', 'pth', 'bin'];
                if (known_extensions.includes(extension)) {
                    type = extension;
                }
            }
            fileType.textContent = type;
            
            fileModified.textContent = new Date(file.lastModified).toLocaleString('en-US');
            fileInfo.classList.remove('d-none');
        } else {
            fileInfo.classList.add('d-none');
        }
    });
    
    // Handle form submission with progress
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('DEBUG: Upload form submitted.');
        
        const formData = new FormData(this);
        const xhr = new XMLHttpRequest();
        
        // Hide the form and show progress
    document.getElementById('uploadFormContent').classList.add('d-none');
    uploadProgress.classList.remove('d-none');
        
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Upload in progress...';
        
        // Track upload start time
        const startTime = Date.now();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                const roundedPercent = Math.round(percentComplete);
                
                // Update progress bar
                progressBar.style.width = percentComplete + '%';
                progressBar.querySelector('span').textContent = roundedPercent + '%';
                
                // Update progress information
                const uploadSpeed = calculateSpeed(e.loaded, Date.now() - startTime);
                const timeRemaining = estimateTimeRemaining(e.loaded, e.total, startTime);
                
                const progressTitle = document.getElementById('progressTitle');
                const progressText = document.getElementById('progressText');
                const uploadStats = document.getElementById('uploadStats');
                
                progressTitle.textContent = 'Uploading Model';
                progressText.textContent = 'Transferring file to server...';
                uploadStats.textContent = `${formatFileSize(e.loaded)} of ${formatFileSize(e.total)} • ${uploadSpeed} • ${timeRemaining}`;
                
                if (percentComplete === 100) {
                    progressTitle.textContent = 'Processing Model';
                    progressText.textContent = 'Upload complete, processing on server...';
                    uploadStats.textContent = 'This may take a few moments...';
                }
            }
        });
        
        // Helper functions for progress calculations
        function calculateSpeed(loaded, timeElapsed) {
            const speedBps = loaded / (timeElapsed / 1000);
            return formatFileSize(speedBps) + '/s';
        }
        
        function estimateTimeRemaining(loaded, total, startTime) {
            const timeElapsed = Date.now() - startTime;
            const timeRemaining = (timeElapsed * (total / loaded - 1)) / 1000;
            
            if (timeRemaining < 60) {
                return Math.round(timeRemaining) + ' seconds left';
            } else {
                return Math.round(timeRemaining / 60) + ' minutes left';
            }
        }
        
        // Handle completion
        xhr.addEventListener('load', function() {
            console.log('DEBUG: XHR load event received. Status:', xhr.status);
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                console.log('DEBUG: Server response:', response);
                if (response.success) {
                    // Zeige grüne Alert-Box und Spinner, reduziere Statusmeldungen
                    progressBar.classList.remove('progress-bar-animated', 'bg-danger');
                    progressBar.classList.add('bg-success');
                    progressBar.style.width = '100%';
                    progressBar.querySelector('span').textContent = '100%';
                    progressTitle.textContent = 'Upload completed';
                    progressText.textContent = '';
                    uploadStats.textContent = '';
                    document.getElementById('uploadSuccessAlert').classList.remove('d-none');
                    document.getElementById('processingSpinner').classList.remove('d-none');
                    // Poll for processing status
                    const interval = setInterval(() => {
                        fetch(`/api/process-status/${response.process_id}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'completed' || data.status === 'failed') {
                                    clearInterval(interval);
                                    document.getElementById('processingSpinner').classList.add('d-none');
                                    if (data.status === 'completed') {
                                        progressTitle.textContent = 'Finished!';
                                        progressText.textContent = 'The model has been processed.';
                                    } else {
                                        progressTitle.textContent = 'Error!';
                                        progressText.textContent = `Processing failed: ${data.error || 'Unknown Error'}`;
                                        progressBar.classList.add('bg-danger');
                                    }
                                    setTimeout(() => {
                                        // Hide progress bar, show form again, reset fields
                                        document.getElementById('uploadSuccessAlert').classList.add('d-none');
                                        uploadProgress.classList.add('d-none');
                                        form.reset();
                                        fileInfo.classList.add('d-none');
                                        progressBar.style.width = '0%';
                                        progressBar.classList.remove('bg-success', 'bg-danger');
                                        progressBar.classList.add('progress-bar-animated', 'bg-primary');
                                        progressBar.querySelector('span').textContent = '0%';
                                        progressTitle.textContent = 'Uploading Model';
                                        progressText.textContent = 'Preparing upload...';
                                        uploadStats.textContent = '';
                                        document.getElementById('uploadFormContent').classList.remove('d-none');
                                        uploadButton.disabled = true;
                                        uploadButton.innerHTML = '<i class="fas fa-upload me-2"></i>Upload Model';
                                    }, 2000);
                                } else if (data.status === 'processing') {
                                    progressTitle.textContent = 'Processing...';
                                    progressText.textContent = '';
                                    uploadStats.textContent = '';
                                    // Update progress bar if progress is available
                                    if (data.progress !== undefined) {
                                        const percent = Math.round(data.progress * 100);
                                        progressBar.style.width = percent + '%';
                                        progressBar.querySelector('span').textContent = percent + '%';
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('ERROR: Polling failed:', error);
                                clearInterval(interval);
                                progressText.innerHTML = '<div class="alert alert-danger mt-2">Error checking processing status.</div>';
                                progressBar.classList.add('bg-danger');
                                uploadProgress.classList.remove('d-none');
                                // uploadForm.classList.add('d-none'); // Keep form hidden on polling error
                            });
                    }, 2000);
                } else {
                    // Server reported failure
                    progressBar.classList.add('bg-danger');
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.style.width = '100%';
                    progressBar.querySelector('span').textContent = 'Error';
                    progressText.innerHTML = `<div class="alert alert-danger mt-2">${response.message || 'Upload error!'}</div>`;
                    uploadStats.textContent = '';
                    uploadProgress.classList.remove('d-none');
                    uploadForm.classList.remove('d-none');
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = '<i class="fas fa-upload me-2"></i>Upload Model';
                    console.error('ERROR: Server reported upload failure:', response.message);
                }
            } else {
                // HTTP status not 200
                progressBar.classList.add('bg-danger');
                progressBar.classList.remove('progress-bar-animated');
                progressBar.style.width = '100%';
                progressBar.querySelector('span').textContent = 'Error';
                progressText.innerHTML = '<div class="alert alert-danger mt-2">Upload error! Server responded with status ' + xhr.status + '</div>';
                uploadStats.textContent = '';
                uploadProgress.classList.remove('d-none');
                uploadForm.classList.remove('d-none');
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload Model';
                console.error('ERROR: XHR status not 200. Status:', xhr.status);
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            progressText.textContent = 'Network error! Please check your connection.';
            progressBar.classList.add('bg-danger');
            uploadProgress.classList.remove('d-none'); // Keep progress visible for error
            uploadForm.classList.remove('d-none'); // Show form again on error
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Upload Model';
            console.error('ERROR: XHR network error.');
        });
        
        // Send request
        xhr.open('POST', '{{ url_for("upload") }}');
        xhr.send(formData);
    });
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Handle collapse arrow rotation
    const uploadProcessCollapse = document.getElementById('uploadProcessCollapse');
    const collapseArrow = document.querySelector('button[data-bs-target="#uploadProcessCollapse"] .collapse-arrow');

    uploadProcessCollapse.addEventListener('show.bs.collapse', function () {
        collapseArrow.classList.remove('fa-chevron-right');
        collapseArrow.classList.add('fa-chevron-down');
    });

    uploadProcessCollapse.addEventListener('hide.bs.collapse', function () {
        collapseArrow.classList.remove('fa-chevron-down');
        collapseArrow.classList.add('fa-chevron-right');
    });

    // Drag and Drop functionality
    const dropArea = document.querySelector('.upload-area');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false);

    function preventDefaults (e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        dropArea.classList.add('border-primary');
        dropArea.classList.add('bg-light');
    }

    function unhighlight(e) {
        dropArea.classList.remove('border-primary');
        dropArea.classList.remove('bg-light');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            fileInput.files = files; // Assign files to the original form input
            fileInput.dispatchEvent(new Event('change')); // Trigger change event
        }
    }
});
</script>
{% endblock %}