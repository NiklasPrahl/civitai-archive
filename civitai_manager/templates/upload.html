{% extends "base.html" %}

{% block title %}Model Upload - Civitai Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-upload me-2"></i>
        Model Upload
    </h1>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>
        Back to Dashboard
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Upload New Model
                </h5>
            </div>
            <div class="card-body">
                <div id="uploadContentWrapper">
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-4">
                            <label for="{{ form.model_file.id }}" class="form-label">
                                <i class="fas fa-file me-1"></i>
                                Select Model File
                            </label>
                            <div class="input-group">
                                {{ form.model_file(class="form-control", accept=".safetensors,.ckpt,.pt,.pth,.bin") }}
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('{{ form.model_file.id }}').click()">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                            </div>
                            
                            {% if form.model_file.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.model_file.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-4 text-center border rounded p-4" id="dropArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Drag & Drop your model file here</p>
                            <input type="file" id="hiddenFileInput" style="display: none;" accept=".safetensors,.ckpt,.pt,.pth,.bin">
                        </div>
                        
                        <div class="mb-4">
                            <p>
                                <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#uploadProcessCollapse" aria-expanded="false" aria-controls="uploadProcessCollapse">
                                    <i class="fas fa-info-circle me-2"></i>
                                    What happens during upload?
                                    <i class="fas fa-chevron-right ms-2 collapse-arrow"></i>
                                </button>
                            </p>
                            <div class="collapse" id="uploadProcessCollapse">
                                <div class="card card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong>File is saved</strong><br>
                                                    <small class="text-muted">In the configured models directory</small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong>Automatic processing starts</strong><br>
                                                    <small class="text-muted">Model is processed immediately after upload</small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong>Metadata is retrieved</strong><br>
                                                    <small class="text-muted">From Civitai based on file hash</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong>Preview images are downloaded</strong><br>
                                                    <small class="text-muted">Based on your configuration</small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong>HTML overview is updated</strong><br>
                                                    <small class="text-muted">Automatically after processing</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File Info -->
                        <div id="fileInfo" class="card my-4 d-none shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-info me-2"></i>
                                    File Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Filename:</strong> <span id="fileName"></span></p>
                                        <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>File Type:</strong> <span id="fileType"></span></p>
                                        <p><strong>Last Modified:</strong> <span id="fileModified"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-primary btn-lg", id="submitBtn") }}
                        </div>
                    </form>
                    
                    <!-- Upload Progress - Integrated into card-body -->
                    <div id="uploadProgress" class="d-none p-3">
                        <h5 class="mb-3 text-center">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Upload in Progress...
                        </h5>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar">
                                0%
                            </div>
                        </div>
                        <div id="progressText" class="text-muted text-center">
                            Preparing upload...
                        </div>
                    </div>

                    <!-- New Success Message Div -->
                    <div id="uploadSuccessMessage" class="d-none p-3 text-center">
                        <h5 class="mb-3 text-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Upload and Processing Complete!
                        </h5>
                        <p>Your model has been successfully uploaded and processed. You will be redirected to the dashboard shortly.</p>
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload Progress -->
        <div id="uploadProgress" class="card mt-4 d-none">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Upload in Progress...
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progressBar">
                        0%
                    </div>
                </div>
                <div id="progressText" class="text-muted">
                    Preparing upload...
                </div>
            </div>
        </div>
        
        <!-- Help & Tips Button -->
        <div class="text-center mt-4">
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="fas fa-question-circle me-2"></i>
                Help & Tips
            </button>
        </div>

        <!-- Help Modal -->
        <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="helpModalLabel">
                            <i class="fas fa-question-circle me-2"></i>
                            Help & Tips
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Supported Formats:</h6>
                                <ul class="small">
                                    <li><strong>.safetensors</strong> - Safe tensor files</li>
                                    <li><strong>.ckpt</strong> - Checkpoint files</li>
                                    <li><strong>.pt/.pth</strong> - PyTorch models</li>
                                    <li><strong>.bin</strong> - Binary model files</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Important Notes:</h6>
                                <ul class="small">
                                    <li>Maximum file size: 500MB</li>
                                    <li>Files are processed automatically</li>
                                    <li>Metadata is retrieved from Civitai</li>
                                    <li>Preview images are downloaded</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> Make sure you have configured the directories before uploading models.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const fileInput = document.getElementById('{{ form.model_file.id }}');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    const fileModified = document.getElementById('fileModified');
    const uploadForm = document.getElementById('uploadForm'); // The form itself
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const submitBtn = document.getElementById('submitBtn');
    const uploadSuccessMessage = document.getElementById('uploadSuccessMessage'); // New element
    const uploadContentWrapper = document.getElementById('uploadContentWrapper'); // New element

    // Initially hide progress and success messages
    uploadProgress.classList.add('d-none');
    uploadSuccessMessage.classList.add('d-none');
    uploadForm.classList.remove('d-none'); // Ensure form is visible initially

    // Show file info when file is selected
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            let type = file.type || 'Unknown';
            const extension = file.name.split('.').pop().toLowerCase();
            if (type === 'Unknown' || type === 'application/octet-stream') {
                const known_extensions = ['safetensors', 'ckpt', 'pt', 'pth', 'bin'];
                if (known_extensions.includes(extension)) {
                    type = extension;
                }
            }
            fileType.textContent = type;
            
            fileModified.textContent = new Date(file.lastModified).toLocaleString('en-US');
            fileInfo.classList.remove('d-none');
        } else {
            fileInfo.classList.add('d-none');
        }
    });
    
    // Handle form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('DEBUG: Upload form submitted.');
        
        const formData = new FormData(this);
        const xhr = new XMLHttpRequest();
        
        // Hide the form and show progress
        uploadForm.classList.add('d-none');
        uploadProgress.classList.remove('d-none');
        uploadSuccessMessage.classList.add('d-none'); // Ensure success message is hidden
        
        submitBtn.disabled = true; // This button is now hidden, but good practice to disable
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Upload in progress...';
        
        // Progress tracking
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = Math.round(percentComplete) + '%';
                
                if (percentComplete < 100) {
                    progressText.textContent = 'Uploading file...';
                } else {
                    progressText.textContent = 'File uploaded, server is processing...';
                }
            }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
            console.log('DEBUG: XHR load event received. Status:', xhr.status);
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                console.log('DEBUG: Server response:', response);
                if (response.success) {
                    progressText.textContent = response.message;
                    progressBar.classList.remove('progress-bar-animated');
                    
                    // Poll for processing status
                    console.log('DEBUG: Starting polling for processing status...');
                    const interval = setInterval(() => {
                        fetch('/api/status')
                            .then(response => response.json())
                            .then(data => {
                                console.log('DEBUG: Polling status:', data.is_processing);
                                if (!data.is_processing) {
                                    clearInterval(interval);
                                    uploadProgress.classList.add('d-none'); // Hide progress bar
                                    uploadSuccessMessage.classList.remove('d-none'); // Show success message
                                    
                                    console.log('DEBUG: Processing complete, redirecting to index.');
                                    setTimeout(() => {
                                        window.location.href = '{{ url_for("index") }}';
                                    }, 2000); // Give user a moment to see success message
                                } else {
                                    progressText.textContent = 'Processing... please wait.';
                                }
                            })
                            .catch(error => {
                                console.error('ERROR: Polling failed:', error);
                                clearInterval(interval);
                                progressText.textContent = 'Error checking processing status.';
                                progressBar.classList.add('bg-danger');
                                uploadProgress.classList.remove('d-none'); // Keep progress visible for error
                                uploadForm.classList.add('d-none'); // Keep form hidden
                            });
                    }, 2000);
                } else {
                    // Server reported failure
                    progressText.textContent = response.message || 'Upload error!';
                    progressBar.classList.add('bg-danger');
                    uploadProgress.classList.remove('d-none'); // Keep progress visible for error
                    uploadForm.classList.remove('d-none'); // Show form again on error
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '{{ form.submit.label.text }}';
                    console.error('ERROR: Server reported upload failure:', response.message);
                }
            } else {
                // HTTP status not 200
                progressText.textContent = 'Upload error! Server responded with status ' + xhr.status;
                progressBar.classList.add('bg-danger');
                uploadProgress.classList.remove('d-none'); // Keep progress visible for error
                uploadForm.classList.remove('d-none'); // Show form again on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = '{{ form.submit.label.text }}';
                console.error('ERROR: XHR status not 200. Status:', xhr.status);
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            progressText.textContent = 'Network error! Please check your connection.';
            progressBar.classList.add('bg-danger');
            uploadProgress.classList.remove('d-none'); // Keep progress visible for error
            uploadForm.classList.remove('d-none'); // Show form again on error
            submitBtn.disabled = false;
            submitBtn.innerHTML = '{{ form.submit.label.text }}';
            console.error('ERROR: XHR network error.');
        });
        
        // Send request
        xhr.open('POST', '{{ url_for("upload") }}');
        xhr.send(formData);
    });
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Handle collapse arrow rotation
    const uploadProcessCollapse = document.getElementById('uploadProcessCollapse');
    const collapseArrow = document.querySelector('button[data-bs-target="#uploadProcessCollapse"] .collapse-arrow');

    uploadProcessCollapse.addEventListener('show.bs.collapse', function () {
        collapseArrow.classList.remove('fa-chevron-right');
        collapseArrow.classList.add('fa-chevron-down');
    });

    uploadProcessCollapse.addEventListener('hide.bs.collapse', function () {
        collapseArrow.classList.remove('fa-chevron-down');
        collapseArrow.classList.add('fa-chevron-right');
    });

    // Drag and Drop functionality
    const dropArea = document.getElementById('dropArea');
    const hiddenFileInput = document.getElementById('hiddenFileInput');
    const browseFiles = document.getElementById('browseFiles');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false); // Prevent default for entire body
    });

    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false);

    // Handle browse link click
    browseFiles.addEventListener('click', function(e) {
        e.preventDefault();
        hiddenFileInput.click();
    });

    // Handle file selection from hidden input
    hiddenFileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileInput.files = this.files; // Assign files to the original form input
            fileInput.dispatchEvent(new Event('change')); // Trigger change event
        }
    });

    function preventDefaults (e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        dropArea.classList.add('border-primary');
        dropArea.classList.add('bg-light');
    }

    function unhighlight(e) {
        dropArea.classList.remove('border-primary');
        dropArea.classList.remove('bg-light');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            fileInput.files = files; // Assign files to the original form input
            fileInput.dispatchEvent(new Event('change')); // Trigger change event
        }
    }
});
</script>
{% endblock %} 